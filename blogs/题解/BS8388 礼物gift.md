# BS8388 礼物gift

**[题目传送门]()**

## Problem

有一棵 $n$ （$1\le n\le3\times10^5$）个点的树，由儿子指向父亲的单向边组成。每个点有一种颜色 $color_i$（$color_i\le m\le10^3$）。

有 $q$ （$0\le q\le5\times10^4$） 个询问，每个询问给定 $c$ （$2\le C\le 5$）个点。

令这 $c$ 个点的 LCA 为 $p$，要求对于 $c$ 个点中每个点，在它到 $p$ 的链上选择相同的颜色种数，且每种颜色最多被选一次。

问最多有多少种颜色被选。

## Solution

首先我们想要求出询问的 $c$ 条链上的颜色集合。将问题从树上剥离下来。

考虑重链剖分，用线段树维护区间 $bitset$ 并集。预处理每个点到所在重链链顶路径的颜色集合，询问时只需对最上面的一段在线段树上询问。时间复杂度 $O(\frac{nm}{\omega}+\frac{qcm\log n}{\omega})$。

我们发现这个问题是可以网络流跑的——从每个点向对应链上包含的颜色连边，源点向每个点连一条特定容量的边，颜色向汇点连边，跑最大流，满流则可行。容量可以二分，但这样复杂度是 $O(maxflow(n+m,nm)\log m)$ 的，会 TLE。

换一种思路，现在求出了 $c$ 条链上的颜色集合。$O(\frac{qm2^c}{\omega})$ 求出 $dp_S$ 表示集合 $S$ 中的链的颜色集合的并。
